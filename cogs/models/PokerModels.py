from ..DB import Data
from ..configs import MainConfig as MC
from discord.ext import commands
# from discord import Interaction

class Room(Data):
    def __init__(self, ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ):
        self.row = Data.Room.find_one({"ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ": ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ})
        if not self.row:
            raise ValueError(f"ÐšÐ¾Ð¼Ð½Ð°Ñ‚Ð° '{ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ}' Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°!")
        self.ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ = self.row["ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ"]
        self.Ð£Ñ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¸ = self.row["Ð£Ñ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¸"]
        self.ÐŸÐ¾Ñ€ÑÐ´Ð¾Ðº_Ñ…Ð¾Ð´Ð¾Ð² = self.row["ÐŸÐ¾Ñ€ÑÐ´Ð¾Ðº_Ñ…Ð¾Ð´Ð¾Ð²"]
        self.ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼_ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð² = self.row["ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼_ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²"]
        self.ÐŸÐ°Ñ€Ð¾Ð»ÑŒ = self.row["ÐŸÐ°Ñ€Ð¾Ð»ÑŒ"]
        self.ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° = self.row["ÐŸÑ€Ð°Ð²Ð¸Ð»Ð°"]
        self.Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÐµÐ»ÑŒ = self.row["Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÐµÐ»ÑŒ"]
        self.ÐšÐ°Ð½Ð°Ð» = self.row["ÐšÐ°Ð½Ð°Ð»"]
        self.Ð Ð¾Ð»ÑŒ = self.row["Ð Ð¾Ð»ÑŒ"]
        self.Ð§Ð¡ = self.row["Ð§Ð¡"]
        self.ID_Ð¡ÐµÑ€Ð²ÐµÑ€Ð° = self.row["ID_Ð¡ÐµÑ€Ð²ÐµÑ€Ð°"]
        self.ÐšÐ°Ñ€Ñ‚Ñ‹_ÑÑ‚Ð¾Ð»Ð° = self.row["ÐšÐ°Ñ€Ñ‚Ñ‹_ÑÑ‚Ð¾Ð»Ð°"]
        self.ÐœÐ¸Ð½_ÑÑ‚Ð°Ð²ÐºÐ° = self.row["ÐœÐ¸Ð½_ÑÑ‚Ð°Ð²ÐºÐ°"]
        self.ÐœÐ°ÐºÑ_ÑÑ‚Ð°Ð²ÐºÐ° = self.row["ÐœÐ°ÐºÑ_ÑÑ‚Ð°Ð²ÐºÐ°"]
        self.Ð¢Ð¸Ð¿_ÑÑ‚Ð°Ð²Ð¾Ðº = self.row["Ð¢Ð¸Ð¿_ÑÑ‚Ð°Ð²Ð¾Ðº"]
        self.Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹_Ñ€Ð°ÑƒÐ½Ð´ = self.row["Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹_Ñ€Ð°ÑƒÐ½Ð´"]
        self.Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹_Ñ…Ð¾Ð´ = self.row["Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹_Ñ…Ð¾Ð´"]
        self.Ð‘Ð°Ð½Ðº_Ð¾Ð±Ñ‰Ð¸Ð¹ = self.row["Ð‘Ð°Ð½Ðº_Ð¾Ð±Ñ‰Ð¸Ð¹"]
        self.Ð‘Ð°Ð½Ðº_Ñ€Ð°ÑƒÐ½Ð´Ð° = self.row["Ð‘Ð°Ð½Ðº_Ñ€Ð°ÑƒÐ½Ð´Ð°"]
        self.ÐšÐ¾Ð»Ð¾Ð´Ð° = self.row["ÐšÐ¾Ð»Ð¾Ð´Ð°"]
        self.Ð’Ñ€ÐµÐ¼Ñ = self.row["Ð’Ñ€ÐµÐ¼Ñ"]



#                      ------  ÐœÐžÐ”Ð•Ð ÐÐ¦Ð˜Ð¯ ÐšÐžÐœÐÐÐ¢Ð«   ------

    # Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ°
    def add_member(self, member_id):
        if member_id in self.Ð£Ñ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¸:
            raise ValueError("Ð­Ñ‚Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐ¶Ðµ Ð² ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ðµ.")
        if len(self.Ð£Ñ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¸) >= self.ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼_ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²:
            raise ValueError("ÐšÐ¾Ð¼Ð½Ð°Ñ‚Ð° Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð°.")
        Data.Room.update_one({"ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ": self.ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ}, {"$push": {"Ð£Ñ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¸": member_id}})
        return self.__init__(self.ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ) # Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚Ñ‹

    # Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ°
    def remove_member(self, member_id):
        Data.Room.update_one({"ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ": self.ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ}, {"$pull": {"Ð£Ñ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¸": member_id}})
        return self.__init__(self.ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ)

    # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð° ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹
    def update_field(self, field: str, value):
        """
        print(f"ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»Ñ: {field}, Ð½Ð¾Ð²Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ: {value}")  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹ +
        if isinstance(value, list):
            print("ÐŸÐµÑ€ÐµÐ´Ð°Ð½Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ â€” ÑÑ‚Ð¾ ÑÐ¿Ð¸ÑÐ¾Ðº")  # ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ ÑÐ¿Ð¸ÑÐ¾Ðº (ÐµÑÐ»Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº, ÐºÐ¾Ð½ÐµÑ‡Ð½Ð¾) +
        """
        Data.Room.update_one({"ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ": self.ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ}, {"$set": {field: value}})
        # ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¾Ð±ÑŠÐµÐºÑ‚ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹ Ð´Ð»Ñ Ð°ÐºÑ‚ÑƒÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…:
        return self.__init__(self.ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ)

    # Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹
    def delete_room(self):
        Data.Room.delete_one({"ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ": self.ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ})
        #return self.__init__(self.ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ)

    # Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ° Ð² Ð§Ð¡
    def add_member_BL(self, member_id):
        if member_id in self.Ð§Ð¡:
            raise ValueError("Ð­Ñ‚Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐ¶Ðµ Ð² Ð§Ð¡.")
        Data.Room.update_one({"ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ": self.ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ}, {"$push": {"Ð§Ð¡": member_id}})
        return self.__init__(self.ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ) # Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚Ñ‹
    
    # Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ° Ð² Ð§Ð¡
    def remove_member_BL(self, member_id):
        if not (member_id in self.Ð§Ð¡):
            raise ValueError("Ð­Ñ‚Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ÑƒÐ¶Ðµ Ð½ÐµÑ‚ Ð² Ð§Ð¡.")
        Data.Room.update_one({"ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ": self.ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ}, {"$pull": {"Ð§Ð¡": member_id}})
        return self.__init__(self.ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ) # Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚Ñ‹
    
    # Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¿Ð¸ÑÐºÐ° ÐºÐ¾Ð¼Ð½Ð°Ñ‚
    @staticmethod
    def format_room_list(rooms): # , interaction: Interaction
        formatted_rooms = []
        n: int = 0 # ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ ÐºÐ¾Ð»-Ð²Ð¾ ÐºÐ¾Ð¼Ð½Ð°Ñ‚ Ð´Ð»Ñ Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ (Ð´Ð¾ 10 ÑˆÑ‚. Ð½Ð° ÑÑ‚Ñ€.)
        room_info: str = '' # ÑÐ¿Ð¸ÑÐ¾Ðº ÐºÐ¾Ð¼Ð½Ð°Ñ‚ Ð½Ð° ÐºÐ°Ð¶Ð´ÑƒÑŽ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ
        for room in rooms:
            n += 1
            # print('room\n', room, n) # +
            password_icon = "ðŸ”" if room["ÐŸÐ°Ñ€Ð¾Ð»ÑŒ"] else "" # ðŸ” ðŸ”’
            Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ = room['ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ']
            room_info +=    f"> {n}. {Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ} {password_icon}\n" \
                            f"> ```{Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ}```" \
                            f"ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº: {len(room['Ð£Ñ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¸'])}/{room['ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼_ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²']}\n" \
                            f"> Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÐµÐ»ÑŒ: <@{room['Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÐµÐ»ÑŒ']}>\n" \
                            f"> ÐœÐ¸Ð½. ÑÑ‚Ð°Ð²ÐºÐ°: {room['ÐœÐ¸Ð½_ÑÑ‚Ð°Ð²ÐºÐ°']}\n" \
                            f"> ÐœÐ°ÐºÑ. ÑÑ‚Ð°Ð²ÐºÐ°: {room['ÐœÐ°ÐºÑ_ÑÑ‚Ð°Ð²ÐºÐ°']}"
            room_info += "\n\n"
            if n % 10 == 0: # ÐºÐ°Ð¶Ð´Ñ‹Ðµ Ð´ÐµÑÑÑ‚ÑŒ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ† Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð° Ð¾Ð´Ð½Ñƒ ÑÑ‚Ñ€: (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ ÐºÐ°Ð¶Ð´Ñ‹Ðµ 15, Ñ‚Ð¾ if n % 15 == 0 Ð¸ Ñ‚.Ð´.)
                formatted_rooms.append(room_info)
                room_info = '' # Ð¾Ð±Ð½ÑƒÐ»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð´Ð»Ñ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¹ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
            else: pass
        formatted_rooms.append(room_info) # Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð²Ñ‹ÑˆÐ»Ð¸ Ð·Ð° Ð¿Ñ€ÐµÐ´ÐµÐ»Ñ‹ Ð´ÐµÑÑÑ‚Ð¾Ðº
        # print('formatted_rooms\n', formatted_rooms) # +
        return formatted_rooms # Ð•ÑÐ»Ð¸ Ð·Ð°Ñ…Ð¾Ñ‚Ð¸Ð¼ Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ Ð½Ðµ ÑÐ¿Ð¸ÑÐ¾Ðº, Ð° Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼ Ð²ÑÐµ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹ ÑÑ€Ð°Ð·Ñƒ, Ñ‚Ð¾ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ "\n\n".join(formatted_rooms)




#                      ------  Ð Ð•ÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð¯ Ð˜Ð“Ð Ð«   ------

# Ð¼ÐµÑ‚Ð¾Ð´ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ…Ð¾Ð´Ð¾Ð² (inc) - Ð¿Ñ€Ð¸Ð±Ð°Ð²Ð¸Ñ‚ÑŒ
    def ÑÐ»ÐµÐ´_Ñ…Ð¾Ð´(self):
        Data.Room.update_one({"ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ": self.ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ}, {"$inc": {'Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹_Ñ…Ð¾Ð´': 1}}) # Ð´ÐµÐ»Ð°ÐµÑ‚ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ Ðº ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¼Ñƒ Ñ…Ð¾Ð´Ñƒ (+1)
        return self.__init__(self.ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ)

# Ð¼ÐµÑ‚Ð¾Ð´ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ€Ð°ÑƒÐ½Ð´Ð¾Ð² (Ð¾Ñ‚Ð¿Ñ€Ð°Ð°Ð²Ð»ÑÐµÐ¼ ÑÑŽÐ´Ð° Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ€Ð°ÑƒÐ½Ð´Ð°)
    def ÑÐ»ÐµÐ´_Ñ€Ð°ÑƒÐ½Ð´(self, Ñ€Ð°ÑƒÐ½Ð´: str):
        Data.Room.update_one({"ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ": self.ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ}, {"$set": {'Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹_Ñ€Ð°ÑƒÐ½Ð´': Ñ€Ð°ÑƒÐ½Ð´}}) # Ð´ÐµÐ»Ð°ÐµÑ‚ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ Ðº ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¼Ñƒ Ñ€Ð°ÑƒÐ½Ð´Ñƒ
        return self.__init__(self.ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ)
    
# Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð´ÐµÐ½ÐµÐ³ Ð² Ð±Ð°Ð½Ðº

async def setup(bot: commands.Bot) -> None:
    await bot.add_cog(Room(bot))